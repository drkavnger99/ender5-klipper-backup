#[gcode_macro FILAMENT_RUNOUT]
#description: Handle filament runout
#gcode:
#    M83                             ; Ensure relative extrusion
#    PAUSE                           ; Pause the print (includes saving position)
#    G91
#    G1 E-1 F300
#    G1 Z10 F600
#    G90
#    G1 X261 Y221 F6000
#    M104 S0                         ; Turn off hotend
#    RESPOND TYPE=echo MSG="Filament runout detected - print paused and parked"

[gcode_macro FILAMENT_RUNOUT]
description: Handle filament runout but continue printing for 120mm before pausing
gcode:
    {% set extra_length = 100.0 %}     # distance to continue printing after runout (in mm)
    M83                                ; relative extrusion mode
    RESPOND TYPE=echo MSG="Filament runout detected - continuing for {{ extra_length }}mm before pause"
    # Allow extrusion to continue for 120mm before pausing
    RUNOUT_DELAY_START

[gcode_macro RUNOUT_DELAY_START]
description: Continue printing for a short distance after runout
gcode:
    {% set extra_length = 120.0 %}
    {% set feedrate = 1500 %}          # feedrate for extra extrusion distance
    RESPOND TYPE=echo MSG="Continuing print for {{ extra_length }}mm of filament"
    G91
    G1 E{{ extra_length }} F{{ feedrate }}  ; feed the remaining filament
    G90
    RESPOND TYPE=echo MSG="Runout delay complete â€” pausing now"
    PAUSE
    G91
    G1 E-1 F300
    G1 Z10 F600
    G90
    G1 X261 Y221 F6000
    M104 S0
    RESPOND TYPE=echo MSG="Print paused and parked after runout delay"

[delayed_gcode DISABLEFILAMENTSENSOR]
initial_duration: 1
gcode:
    SET_FILAMENT_SENSOR SENSOR=switch_sensor ENABLE=0
    SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=0

[gcode_macro SFS_ENABLE]
description: Enable smart filament sensor
gcode:
    M117 ENABLING the Smart Filament Sensor
    G92 E0
    SET_FILAMENT_SENSOR SENSOR=switch_sensor ENABLE=1
    SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=1

[gcode_macro SFS_DISABLE]
description: Disable smart filament sensor
gcode:
    M117 DISABLING the Smart Filament Sensor
    G92 E0
    SET_FILAMENT_SENSOR SENSOR=switch_sensor ENABLE=0
    SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=0
    M117 Remove filament
